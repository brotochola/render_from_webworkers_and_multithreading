<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>PixiJS 8 - Workers vs Main Thread</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #111;
        }

        canvas {
            display: block;
            width: 800px;
            height: 600px;
            border: 1px solid #333;
        }

        p {
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        #config {
            color: #4CAF50;
            font-weight: bold;
            font-size: 18px;
        }
    </style>
</head>
<body>

    <p id="config"></p>
    <p id="pixiWorkerFPS"></p>
    <p id="logicWorkerFPS"></p>

    <!-- Load scripts in order -->
    <script src="boid.js"></script>
    <script src="main_thread.js"></script>
    <script>

        // ==================== CONFIGURATION ====================
        const config = {
            useWorkers: true  // Set to true to use workers, false to run on main thread
        };
        // =======================================================

        document.querySelector('#config').textContent =
            `Mode: ${config.useWorkers ? 'WORKERS' : 'MAIN THREAD'}`;

        const width = 800, height = 600;
        const resolution = window.devicePixelRatio;

        if (config.useWorkers) {
            // ==================== WORKERS MODE ====================
            console.log("Starting in WORKERS mode");

            const canvas = document.createElement('canvas');
            canvas.style.width = `${width}px`;
            canvas.style.height = `${height}px`;
            document.body.appendChild(canvas);

            // Crear los workers
            const pixiWorker = new Worker('pixi_worker.js');
            const logicWorker = new Worker('logic_worker.js');

            // Crear un MessageChannel para comunicaciÃ³n directa entre workers
            const channel = new MessageChannel();

            // Transferir el canvas al pixi worker
            const view = canvas.transferControlToOffscreen();
            pixiWorker.postMessage({ msg: "init", width, height, resolution, view }, [view]);

            // Enviar un puerto del canal a cada worker para que se comuniquen directamente
            pixiWorker.postMessage({ msg: "setPort", port: channel.port1 }, [channel.port1]);
            logicWorker.postMessage({ msg: "setPort", port: channel.port2 }, [channel.port2]);

            // Escuchar mensajes del pixi worker (solo para debugging/UI)
            pixiWorker.onmessage = (e) => {
                if (e.data.msg === "fps") {
                    document.querySelector('#pixiWorkerFPS').textContent = "pixi worker fps: " + e.data.fps;
                }
            }

            // Escuchar mensajes del logic worker (solo para debugging/UI)
            logicWorker.onmessage = (e) => {
                if (e.data.msg === "fps") {
                    document.querySelector('#logicWorkerFPS').textContent = "logic worker fps: " + e.data.fps;
                }
            }
        } else {
            // ==================== MAIN THREAD MODE ====================
            console.log("Starting in MAIN THREAD mode");

            // Load PIXI script dynamically, then initialize main thread
            const script = document.createElement('script');
            script.src = 'pixi4webworkers.js';
            script.onload = () => initMainThread(width, height, resolution);
            document.head.appendChild(script);
        }
    </script>
</body>
</html>